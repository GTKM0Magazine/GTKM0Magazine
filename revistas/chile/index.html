<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Revista Chile | GTKM0</title>

  <style>
    body{
      background:#1a1a1a;
      margin:0;
      overflow:hidden;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      font-family:Arial, sans-serif;
    }
    .magazine-viewport{
      width:100vw;
      height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      overflow:hidden;
      position:relative;
    }

    #flipbook{
      width:840px;
      height:594px;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease-in;
    }
    @media (max-width:768px){
      #flipbook{
        width:90vw;
        height:calc(90vw * 1.414);
      }
    }

    .page{
      width:420px;
      height:594px;
      background:#fff center/contain no-repeat;
      box-shadow:0 0 20px rgba(0,0,0,.5);
    }

    .btn-download{
      position:absolute;
      top:15px;
      left:15px;
      background:#e60000;
      color:#fff;
      padding:10px 15px;
      text-decoration:none;
      border-radius:6px;
      font-size:12px;
      font-weight:bold;
      z-index:9999;
    }

    .loading{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(255,255,255,.75);
      font-size:13px;
      letter-spacing:.2px;
      pointer-events:none;
    }
  </style>
</head>

<body>
  <div class="magazine-viewport">
    <a href="revista_chile.pdf" class="btn-download" download>DESCARGAR PDF</a>
    <audio id="audioFlip" preload="auto" src="/GTKM0Magazine/assets/page-flip.mp3"></audio>

    <div id="flipbook"></div>
    <div id="loading" class="loading">Cargando revista…</div>
  </div>

  <!-- Librerías: SIEMPRE antes de tu script -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/GTKM0Magazine/assets/turn.min.js"></script>


  <script>
    function preload(urls){
      const TIMEOUT = 6000;
      return Promise.all(urls.map(u => new Promise(res=>{
        const img = new Image();
        const t = setTimeout(()=>res(false), TIMEOUT);
        img.onload = ()=>{ clearTimeout(t); res(true); };
        img.onerror = ()=>{ clearTimeout(t); res(false); };
        img.src = u;
      })));
    }

    function dims(){
      const esMovil = window.matchMedia("(max-width: 768px)").matches;
      const singleW = Math.floor(Math.min(window.innerWidth * 0.9, 420));
      const singleH = Math.floor(singleW * 1.414);
      return {
        esMovil,
        pageW: esMovil ? singleW : 420,
        pageH: esMovil ? singleH : 594,
        width: esMovil ? singleW : 840,
        height: esMovil ? singleH : 594,
        display: esMovil ? "single" : "double"
      };
    }

    // ✅ IMPORTANTE: arranca dentro de jQuery ready (garantiza $ definido)
    $(function(){
      const loading = document.getElementById("loading");

      if(!(jQuery.fn && typeof jQuery.fn.turn === "function")){
        loading.textContent = "No se cargó turn.js (CDN bloqueado).";
        return;
      }

      const fb = $("#flipbook");
      const audio = document.getElementById("audioFlip");

      const totalPaginas = 30;
      const PAGE_BASE = "/GTKM0Magazine/revistas/chile/paginas/";

      fb.empty();
      for(let i=1;i<=totalPaginas;i++){
        const num = String(i).padStart(3,"0");
        fb.append(`<div class="page" style="background-image:url('${PAGE_BASE}${num}.png')"></div>`);
      }

      const first = [1,2,3,4,5,6].map(n => PAGE_BASE + String(n).padStart(3,"0") + ".png");

      preload(first).then(ok=>{
        if(ok.every(v=>!v)){
          loading.textContent = "No se cargan las páginas (ruta/nombres).";
          console.error("Preload fail:", first);
          return;
        }

        const d = dims();
        $(".page").css({ width: d.pageW+"px", height: d.pageH+"px" });

        try { fb.turn("destroy"); } catch(e) {}

        fb.turn({
          width: d.width,
          height: d.height,
          display: d.display,
          autoCenter: true,
          acceleration: true,
          gradients: true,
          elevation: 50,
          when: {
            turning: function(){
              if(audio){
                audio.currentTime = 0;
                audio.play().catch(()=>{});
              }
            }
          }
        });

        fb.css({ opacity: 1, pointerEvents: "auto" });
        loading.style.display = "none";
      });
    });

    let rt;
    window.addEventListener("resize", ()=>{
      clearTimeout(rt);
      rt = setTimeout(()=>location.reload(), 250);
    });
  </script>
</body>
</html>

